{% extends 'xrayapp/base.html' %}
{% load xrayapp_extras %}
{% load i18n %}
{% load tz %}
{% load static %}

{% block title %}{% trans "MCADS results" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'xrayapp/css/print-results.css' %}" media="print">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-2">{% trans "MCADS results" %}</h2>
        
        <!-- OOD Warning Section -->
        {% if xray.requires_expert_review %}
        <div class="card mb-2 border-danger">
            <div class="card-header bg-danger text-white d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-2 fs-5"></i>
                <h5 class="mb-0">{% trans "Out-of-Distribution (OOD) Warning" %}</h5>
            </div>
            <div class="card-body">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <i class="bi bi-exclamation-circle text-danger fs-1 me-3"></i>
                    </div>
                    <div>
                        <h5 class="card-title text-danger">{% trans "Potential Data Quality Issue Detected" %}</h5>
                        <p class="card-text">
                            {% trans "This image has been flagged as Out-of-Distribution (OOD). This means it differs significantly from the data the AI models were trained on." %}
                        </p>
                        <div class="alert alert-warning mb-0">
                            <strong>{% trans "Caution:" %}</strong> {% trans "The analysis results below may be unreliable. A manual review by a medical expert is strongly recommended." %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Severity Level Indicator (MTS) -->
        <div class="card mb-2">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-1">
                <h5 class="mb-0">{% trans "Triage Priority (MTS)" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        {% with severity_level=xray|get_severity_level %}
                        <div class="d-flex align-items-center mb-2 mobile-severity-layout">
                            <div class="text-center me-4 mobile-severity-label" style="min-width: 140px;">
                                <h3 class="mb-1 
                                    {% if severity_level == 1 %}text-danger
                                    {% elif severity_level == 2 %}text-warning
                                    {% elif severity_level == 3 %}text-warning
                                    {% elif severity_level == 4 %}text-success
                                    {% else %}text-info{% endif %} 
                                    fs-4 fs-sm-3">
                                    {{ xray|get_severity_label }}
                                </h3>
                                <div class="small text-muted fw-medium">
                                    {% if severity_level == 1 %}{% trans "0 min (Immediate)" %}
                                    {% elif severity_level == 2 %}{% trans "10 min (Very Urgent)" %}
                                    {% elif severity_level == 3 %}{% trans "60 min (Urgent)" %}
                                    {% elif severity_level == 4 %}{% trans "120 min (Standard)" %}
                                    {% else %}{% trans "240 min (Non-urgent)" %}{% endif %}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted fw-medium">{% trans "Assigned Category" %}</small>
                                    <small class="fw-bold">
                                        {% if severity_level == 1 %}{% trans "Red (Immediate)" %}
                                        {% elif severity_level == 2 %}{% trans "Orange (Very Urgent)" %}
                                        {% elif severity_level == 3 %}{% trans "Yellow (Urgent)" %}
                                        {% elif severity_level == 4 %}{% trans "Green (Standard)" %}
                                        {% else %}{% trans "Blue (Non-urgent)" %}{% endif %}
                                    </small>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    {% if severity_level == 1 %}
                                    <div class="progress-bar bg-danger" role="progressbar" style="width: 100%;" 
                                         aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                                        <span class="progress-text text-white fw-bold">{% trans "IMMEDIATE" %}</span>
                                    </div>
                                    {% elif severity_level == 2 %}
                                    <div class="progress-bar" role="progressbar" style="width: 80%; background-color: #fd7e14;" 
                                         aria-valuenow="80" aria-valuemin="0" aria-valuemax="100">
                                        <span class="progress-text text-white fw-bold">{% trans "VERY URGENT" %}</span>
                                    </div>
                                    {% elif severity_level == 3 %}
                                    <div class="progress-bar bg-warning text-dark" role="progressbar" style="width: 60%;" 
                                         aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                                        <span class="progress-text fw-bold">{% trans "URGENT" %}</span>
                                    </div>
                                    {% elif severity_level == 4 %}
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 40%;" 
                                         aria-valuenow="40" aria-valuemin="0" aria-valuemax="100">
                                        <span class="progress-text text-white fw-bold">{% trans "STANDARD" %}</span>
                                    </div>
                                    {% else %}
                                    <div class="progress-bar bg-info text-white" role="progressbar" style="width: 20%;" 
                                         aria-valuenow="20" aria-valuemin="0" aria-valuemax="100">
                                        <span class="progress-text fw-bold">{% trans "NON-URGENT" %}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <p class="text-muted mb-0">
                            <small>{% trans "Triage category is estimated based on the highest probability pathology found." %}</small>
                        </p>
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Patient Information -->
        <div class="card mb-2">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Patient information" %}</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- First column -->
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                {% for field, value in patient_info.items %}
                                {% if forloop.counter0|divisibleby:2 %}
                                <tr>
                                    <th scope="row" style="width: 40%;">{{ field }}</th>
                                    <td>{{ value|default:"-" }}</td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- Second column -->
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tbody>
                                {% for field, value in patient_info.items %}
                                {% if not forloop.counter0|divisibleby:2 %}
                                <tr>
                                    <th scope="row" style="width: 40%;">{{ field }}</th>
                                    <td>{{ value|default:"-" }}</td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-2">
            <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-1">
                <h5 class="mb-0">{% trans "X-ray image" %}</h5>
                <small>{% trans "Uploaded on" %} {{ xray.uploaded_at|localtime|date:"Y-m-d H:i" }}</small>
            </div>
            <div class="card-body text-center">
                <div class="position-relative d-inline-block">
                    <img src="{{ image_url }}" alt="X-ray Image" class="img-fluid xray-image">
                    <div class="position-absolute bottom-0 end-0 m-2 bg-dark bg-opacity-50 text-white px-2 py-1 rounded small">
                        <i class="bi bi-zoom-in"></i> {% trans "Click to enlarge" %}
                    </div>
                </div>
                
                <!-- Image Metadata -->
                <div class="mt-2 image-metadata-table">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th colspan="{{ image_metadata|length }}" class="text-center">{% trans "Image Metadata" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    {% for field, value in image_metadata.items %}
                                    <td><strong>{{ field }}:</strong> {{ value|default:_("Unknown") }}</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-2">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Prediction Results" %}</h5>
            </div>
            <div class="card-body">
                {% if predictions %}
                <div class="table-responsive">
                    <table class="table table-hover prediction-results-table">
                        <thead>
                            <tr>
                                <th>{% trans "Pathology" %}</th>
                                <th>{% trans "Probability" %}</th>
                                <th>{% trans "Visualize" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pathology, prob in predictions.items %}
                            <tr>
                                <td>
                                    {% trans pathology %}
                                    <button type="button" class="btn-info-pathology ms-2" data-pathology="{{ pathology }}" title="{% trans 'Learn more about' %} {{ pathology }}">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                </td>
                                <td>
                                    <div class="position-relative mobile-pathology-progress">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="badge {% if prob > 0.7 %}bg-very-high{% elif prob > 0.5 %}bg-high{% elif prob >= 0.3 %}bg-medium{% elif prob >= 0.15 %}bg-low{% else %}bg-very-low{% endif %} small fw-medium mobile-risk-badge">
                                                {% if prob > 0.7 %}{% trans "Very High" %}
                                                {% elif prob > 0.5 %}{% trans "High" %}  
                                                {% elif prob >= 0.3 %}{% trans "Medium" %}
                                                {% elif prob >= 0.15 %}{% trans "Low" %}
                                                {% else %}{% trans "Very Low" %}
                                                {% endif %}
                                            </span>
                                            <small class="fw-bold fs-7 fs-sm-6">{{ prob|multiply:100|floatformat:0 }}%</small>
                                        </div>
                                        <div class="progress position-relative mobile-progress-bar">
                                            <div class="progress-bar {% if prob > 0.7 %}bg-very-high{% elif prob > 0.5 %}bg-high{% elif prob >= 0.3 %}bg-medium{% elif prob >= 0.15 %}bg-low{% else %}bg-very-low{% endif %}" 
                                                 role="progressbar" 
                                                 data-probability="{{ prob|percentage }}"
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 aria-label="Pathology probability: {{ prob|floatformat:1 }}%">
                                            </div>
                                            <span class="progress-text small fw-bold">{{ prob|floatformat:3 }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-nowrap">
                                    {% if prob > 0.5 %}
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=gradcam&model_type={{ xray.model_used }}&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" 
                                       data-method="gradcam"
                                       title="{% trans 'Generate Grad-CAM visualization for' %} {{ pathology }}">
                                        {% trans "Grad-CAM" %}
                                    </a>
                                    <a href="{% url 'generate_interpretability' xray.id %}?method=pli&model_type={{ xray.model_used }}&target_class={{ pathology }}" 
                                       class="btn btn-sm btn-outline-secondary interpretation-btn" 
                                       data-method="pli"
                                       title="{% trans 'Generate Pixel-Level interpretability for' %} {{ pathology }}">
                                        {% trans "PLI" %}
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    {% trans "No predictions available yet. This might be because the image is still being processed. Please refresh the page in a few moments." %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Multiple GRAD-CAM Visualizations -->
        {% if gradcam_visualizations %}
        {% for viz in gradcam_visualizations %}
        <div class="card mb-2" id="visualization-{{ viz.id }}">
            <div class="card-header">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-1">
                    <h5 class="mb-0">
                        {% trans "GRAD-CAM visualization" %} - {{ viz.target_pathology }}
                    </h5>
                    <button class="btn btn-sm btn-danger delete-visualization-btn" 
                            data-viz-id="{{ viz.id }}" 
                            data-viz-type="gradcam"
                            data-pathology="{{ viz.target_pathology }}"
                            title="{% trans 'Delete this visualization' %}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-md-6">
                        {# Show the same center-cropped square view the model sees (matches XRayCenterCrop). #}
                        <img src="{{ image_url }}" alt="Original X-ray" class="img-fluid visualization-image">
                        <p class="mt-2 text-center">{% trans "Original X-ray" %}</p>
                    </div>
                    <div class="col-md-6">
                        <img src="{{ viz.overlay_url }}?t={% now 'U' %}" alt="GRAD-CAM Overlay" class="img-fluid visualization-image">
                        <p class="mt-2 text-center">{% trans "GRAD-CAM Overlay" %}</p>
                    </div>
                </div>
                <!-- Visualization Controls -->
                <div class="visualization-controls bg-body border rounded-3 p-2 p-md-2 mt-2 mt-md-2 mb-2 mb-md-2">
                    <!-- Mobile: allow header to wrap so buttons never overflow -->
                    <div class="d-flex flex-wrap align-items-center gap-1 gap-md-2 mb-1 mb-md-2">
                        <small class="text-muted">{% trans "Image Controls" %}</small>
                        <button class="btn btn-sm btn-outline-secondary reset-controls-btn d-inline-flex align-items-center gap-1 ms-auto" data-viz-id="{{ viz.id }}">
                            <i class="fas fa-undo"></i> {% trans "Reset" %}
                        </button>
                    </div>
                    <!-- Mobile: wrap controls; md+: keep single row with horizontal scroll -->
                    <div class="d-flex flex-wrap flex-md-nowrap gap-1 gap-md-2 overflow-auto pb-0 pb-md-1">
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="invert" data-viz-id="{{ viz.id }}" title="{% trans 'Invert Colors' %}">
                            <i class="fas fa-adjust"></i>
                            <span class="btn-label">{% trans "Invert" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="flip-h" data-viz-id="{{ viz.id }}" title="{% trans 'Flip Horizontal' %}">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span class="btn-label">{% trans "Flip H" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="flip-v" data-viz-id="{{ viz.id }}" title="{% trans 'Flip Vertical' %}">
                            <i class="fas fa-arrows-alt-v"></i>
                            <span class="btn-label">{% trans "Flip V" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="rotate" data-viz-id="{{ viz.id }}" title="{% trans 'Rotate 90°' %}">
                            <i class="fas fa-redo"></i>
                            <span class="btn-label">{% trans "Rotate" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="sharpen" data-viz-id="{{ viz.id }}" title="{% trans 'Sharpen' %}">
                            <i class="fas fa-search-plus"></i>
                            <span class="btn-label">{% trans "Sharpen" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="brightness-up" data-viz-id="{{ viz.id }}" title="{% trans 'Increase Brightness' %}">
                            <i class="fas fa-sun"></i>
                            <span class="btn-label">{% trans "Bright +" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="brightness-down" data-viz-id="{{ viz.id }}" title="{% trans 'Decrease Brightness' %}">
                            <i class="fas fa-moon"></i>
                            <span class="btn-label">{% trans "Bright -" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="contrast-up" data-viz-id="{{ viz.id }}" title="{% trans 'Increase Contrast' %}">
                            <i class="fas fa-plus-circle"></i>
                            <span class="btn-label">{% trans "Contrast +" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="contrast-down" data-viz-id="{{ viz.id }}" title="{% trans 'Decrease Contrast' %}">
                            <i class="fas fa-minus-circle"></i>
                            <span class="btn-label">{% trans "Contrast -" %}</span>
                        </button>
                    </div>
                </div>
                
                <p class="mt-2 text-muted">
                    {% trans "GRAD-CAM highlights the regions in the image that strongly influenced the model's prediction for" %} {{ viz.target_pathology }}.
                </p>
                <small class="text-muted">
                    {% trans "Generated on" %}: {{ viz.created_at|localtime|date:"Y-m-d H:i:s" }}
                    {% if viz.threshold %} | {% trans "Threshold" %}: {{ viz.threshold }}{% endif %}
                </small>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <!-- Multiple PLI Visualizations -->
        {% if pli_visualizations %}
        {% for viz in pli_visualizations %}
        <div class="card mb-2" id="visualization-{{ viz.id }}">
            <div class="card-header">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-1">
                    <h5 class="mb-0">
                        {% trans "Pixel-level interpretability" %} - {{ viz.target_pathology }}
                    </h5>
                    <button class="btn btn-sm btn-danger delete-visualization-btn" 
                            data-viz-id="{{ viz.id }}" 
                            data-viz-type="pli"
                            data-pathology="{{ viz.target_pathology }}"
                            title="{% trans 'Delete this visualization' %}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-md-6">
                        <img src="{{ image_url }}" alt="Original X-ray" class="img-fluid visualization-image">
                        <p class="mt-2 text-center">{% trans "Original X-ray" %}</p>
                    </div>
                    <div class="col-md-6">
                        <img src="{{ viz.overlay_url }}?t={% now 'U' %}" alt="Pixel-Level Overlay" class="img-fluid visualization-image">
                        <p class="mt-2 text-center">{% trans "Pixel-level overlay" %}</p>
                    </div>
                </div>
                <!-- Visualization Controls -->
                <div class="visualization-controls bg-body border rounded-3 p-2 p-md-2 mt-2 mt-md-2 mb-2 mb-md-2">
                    <!-- Mobile: allow header to wrap so buttons never overflow -->
                    <div class="d-flex flex-wrap align-items-center gap-1 gap-md-2 mb-1 mb-md-2">
                        <small class="text-muted">{% trans "Image Controls" %}</small>
                        <button class="btn btn-sm btn-outline-secondary reset-controls-btn d-inline-flex align-items-center gap-1 ms-auto" data-viz-id="{{ viz.id }}">
                            <i class="fas fa-undo"></i> {% trans "Reset" %}
                        </button>
                    </div>
                    <!-- Mobile: wrap controls; md+: keep single row with horizontal scroll -->
                    <div class="d-flex flex-wrap flex-md-nowrap gap-1 gap-md-2 overflow-auto pb-0 pb-md-1">
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="invert" data-viz-id="{{ viz.id }}" title="{% trans 'Invert Colors' %}">
                            <i class="fas fa-adjust"></i>
                            <span class="btn-label">{% trans "Invert" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="flip-h" data-viz-id="{{ viz.id }}" title="{% trans 'Flip Horizontal' %}">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span class="btn-label">{% trans "Flip H" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="flip-v" data-viz-id="{{ viz.id }}" title="{% trans 'Flip Vertical' %}">
                            <i class="fas fa-arrows-alt-v"></i>
                            <span class="btn-label">{% trans "Flip V" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="rotate" data-viz-id="{{ viz.id }}" title="{% trans 'Rotate 90°' %}">
                            <i class="fas fa-redo"></i>
                            <span class="btn-label">{% trans "Rotate" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="sharpen" data-viz-id="{{ viz.id }}" title="{% trans 'Sharpen' %}">
                            <i class="fas fa-search-plus"></i>
                            <span class="btn-label">{% trans "Sharpen" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="brightness-up" data-viz-id="{{ viz.id }}" title="{% trans 'Increase Brightness' %}">
                            <i class="fas fa-sun"></i>
                            <span class="btn-label">{% trans "Bright +" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="brightness-down" data-viz-id="{{ viz.id }}" title="{% trans 'Decrease Brightness' %}">
                            <i class="fas fa-moon"></i>
                            <span class="btn-label">{% trans "Bright -" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="contrast-up" data-viz-id="{{ viz.id }}" title="{% trans 'Increase Contrast' %}">
                            <i class="fas fa-plus-circle"></i>
                            <span class="btn-label">{% trans "Contrast +" %}</span>
                        </button>
                        <button class="btn btn-sm btn-outline-primary control-btn d-inline-flex align-items-center gap-1 flex-shrink-0" data-action="contrast-down" data-viz-id="{{ viz.id }}" title="{% trans 'Decrease Contrast' %}">
                            <i class="fas fa-minus-circle"></i>
                            <span class="btn-label">{% trans "Contrast -" %}</span>
                        </button>
                    </div>
                </div>
                
                <p class="mt-2 text-muted">
                    {% trans "Pixel-Level Interpretability shows which individual pixels had the most influence on the model's prediction for" %} {{ viz.target_pathology }}.
                </p>
                <small class="text-muted">
                    {% trans "Generated on" %}: {{ viz.created_at|localtime|date:"Y-m-d H:i:s" }}
                    {% if viz.threshold %} | {% trans "Threshold" %}: {{ viz.threshold }}{% endif %}
                </small>
            </div>
        </div>
        {% endfor %}
        {% endif %}
        
        <!-- Interpretability Processing Feedback -->
        <div id="interpretation-progress" class="card mb-2 mobile-optimized" style="display: none;">
            <div class="card-header">
                <div class="d-flex align-items-center justify-content-center flex-wrap">
                    <h5 class="mb-0 fs-6 fs-sm-5">{% trans "Generating AI Visualization" %}</h5>
                </div>
            </div>
            <div class="card-body">
                <div class="text-center mb-2">
                    <p class="text-muted mb-0">
                        <span id="interpretation-status">{% trans "Initializing visualization engine..." %}</span>
                    </p>
                </div>
                
                <div class="modern-progress pulsing mb-2" 
                     style="height: 30px;" 
                     role="progressbar" 
                     aria-label="{% trans 'Visualization generation progress' %}"
                     aria-valuenow="0" 
                     aria-valuemin="0" 
                     aria-valuemax="100"
                     aria-live="polite"
                     aria-describedby="interpretation-accessibility-status">
                    <div id="interpretation-progress-bar" 
                         class="modern-progress-bar animated" 
                         style="width: 0%;">
                    </div>
                    <span id="interpretation-percentage" class="modern-progress-text">0% {% trans "Complete" %}</span>
                </div>
                
                <!-- Screen reader announcements -->
                <div id="interpretation-accessibility-status" class="visually-hidden" aria-live="polite"></div>
                
                <div class="alert medical-warning mt-2">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <i class="bi bi-eye-fill fs-4"></i>
                        </div>
                        <div class="col">
                            <p class="mb-1">
                                <strong>{% trans "AI Interpretability Processing" %}</strong>
                            </p>
                            <small class="text-muted">
                                {% trans "Generating pixel-level visualization to highlight areas that influenced the AI model's predictions. This advanced process may take up to 60 seconds." %}
                            </small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <p class="mb-0 text-center">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>{% trans "Warning! This tool is not meant to be used without supervision of a medical professional!" %}</strong>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="card mb-2 interpretability-card">
            <div class="card-header">
                <h5 class="mb-0">{% trans "Interpretability options" %}</h5>
            </div>
            <div class="card-body">
                <p>
                    {% trans "Want to understand why the model made these predictions? Try interpretability tools:" %}
                </p>
                <div class="d-flex flex-wrap gap-1 justify-content-center">
                    <a href="{% url 'generate_interpretability' xray.id %}?method=gradcam" 
                       class="btn btn-outline-secondary interpretation-btn" data-method="gradcam">
                        {% trans "Grad-CAM visualization" %}
                    </a>
                    <a href="{% url 'generate_interpretability' xray.id %}?method=pli" 
                       class="btn btn-outline-secondary interpretation-btn" data-method="pli">
                        {% trans "Pixel-Level interpretability" %}
                    </a>
                    <a href="{% url 'generate_segmentation' xray.id %}" 
                       class="btn btn-outline-secondary segmentation-btn" id="segmentation-btn">
                        {% trans "Anatomical Segmentation" %}
                    </a>
                </div>
            </div>
        </div>
        
        <div class="d-flex flex-wrap justify-content-center gap-1 mb-2 stack-mobile">
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">{% trans "Upload new X-ray" %}</a>
            <a href="{% url 'prediction_history' %}" class="btn btn-outline-secondary">{% trans "View prediction history" %}</a>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-printer"></i> {% trans "Print" %}
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" id="print-to-printer"><i class="bi bi-printer"></i> {% trans "Print to printer" %}</a></li>
                    <li><a class="dropdown-item" href="#" id="print-to-pdf"><i class="bi bi-file-pdf"></i> {% trans "Save as PDF" %}</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Pathology Explanation Modal -->
<div class="modal fade" id="pathologyModal" tabindex="-1" aria-labelledby="pathologyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pathologyModalLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    <span id="pathologyName">{% trans "Pathology Information" %}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert medical-warning">
                    <strong><i class="fas fa-exclamation-triangle me-2"></i>Medical Disclaimer:</strong>
                    Always consult with a qualified healthcare professional for proper medical evaluation and treatment.
                </div>
                <p id="pathologyDescription" class="text-justify">
                    <!-- Pathology description will be inserted here -->
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>{% trans "Close" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Visualization Modal -->
<div class="modal fade" id="deleteVisualizationModal" tabindex="-1" aria-labelledby="deleteVisualizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteVisualizationModalLabel">{% trans "Confirm Deletion" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteVisualizationMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteVisualizationBtn">
                    <i class="fas fa-trash me-1"></i> {% trans "Delete" %}
                </button>
            </div>
        </div>
    </div>
</div>

{{ pathology_explanations|json_script:"pathology-data" }}
{{ xray.id|json_script:"xray-id" }}

{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'xrayapp/js/results.js' %}?v=20260127"></script>
{% endblock %}